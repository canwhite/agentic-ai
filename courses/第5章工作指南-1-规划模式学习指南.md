# è§„åˆ’æ¨¡å¼(Planning)å­¦ä¹ æŒ‡å—

> **å­¦ä¹ ç›®æ ‡**ï¼šæŒæ¡è§„åˆ’æ¨¡å¼çš„ä¸‰ç§å®ç°æ–¹å¼ï¼Œèƒ½å¤Ÿä»é›¶æ„å»ºåŸºäºè§„åˆ’çš„æ™ºèƒ½ä½“ç³»ç»Ÿ
>
> **å‰ç½®çŸ¥è¯†**ï¼šå®Œæˆç¬¬1-4ç« ï¼Œç†Ÿæ‚‰åŸºç¡€å·¥ä½œæµã€åæ€æ¨¡å¼ã€å·¥å…·ä½¿ç”¨å’Œè¯„ä¼°æ–¹æ³•
>
> **é¢„è®¡æ—¶é—´**ï¼š120-150åˆ†é’Ÿ

---

## ç›®å½•

0. [å¿«é€Ÿå…¥é—¨ï¼š10åˆ†é’Ÿè§„åˆ’ç¤ºä¾‹](#0-å¿«é€Ÿå…¥é—¨10åˆ†é’Ÿè§„åˆ’ç¤ºä¾‹)
1. [å·¥ä½œæµè§„åˆ’å®ç°](#1-å·¥ä½œæµè§„åˆ’å®ç°)
2. [ç»“æ„åŒ–è¾“å‡ºè§„åˆ’å®ç°](#2-ç»“æ„åŒ–è¾“å‡ºè§„åˆ’å®ç°)
3. [ä»£ç æ‰§è¡Œè§„åˆ’å®ç°](#3-ä»£ç æ‰§è¡Œè§„åˆ’å®ç°)
4. [å®æˆ˜é¡¹ç›®ï¼šå®¢æœä»£ç†ç³»ç»Ÿ](#4-å®æˆ˜é¡¹ç›®å®¢æœä»£ç†ç³»ç»Ÿ)
5. [å®‰å…¨ä¸æœ€ä½³å®è·µ](#5-å®‰å…¨ä¸æœ€ä½³å®è·µ)
6. [å­¦ä¹ è·¯å¾„å»ºè®®](#6-å­¦ä¹ è·¯å¾„å»ºè®®)

---

## 0. å¿«é€Ÿå…¥é—¨ï¼š10åˆ†é’Ÿè§„åˆ’ç¤ºä¾‹

åœ¨æ·±å…¥å­¦ä¹ å®Œæ•´è§„åˆ’æ¡†æ¶å‰ï¼Œå…ˆå°è¯•è¿™ä¸ªç®€å•çš„è§„åˆ’ç¤ºä¾‹ï¼š

åˆ›å»ºæ–‡ä»¶ `quick_planning.py`ï¼š

```python
# quick_planning.py
"""
10åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹è§„åˆ’ - æœ€ç®€å•çš„è§„åˆ’æ¨¡å¼ç¤ºä¾‹
"""

import json

def simple_planner(user_request, available_tools):
    """
    ç®€å•çš„è§„åˆ’å™¨ï¼šæ ¹æ®ç”¨æˆ·è¯·æ±‚å†³å®šä½¿ç”¨å“ªäº›å·¥å…·
    """
    print(f"ğŸ” ç”¨æˆ·è¯·æ±‚: {user_request}")
    print(f"ğŸ› ï¸  å¯ç”¨å·¥å…·: {list(available_tools.keys())}")

    # ç®€å•çš„è§„åˆ™åŒ¹é…ï¼ˆå®é™…ä¸­è¿™é‡Œä¼šè°ƒç”¨LLMï¼‰
    plan = []

    if "åº“å­˜" in user_request or "æœ‰è´§" in user_request:
        plan.append({
            "step": 1,
            "tool": "check_inventory",
            "description": "æ£€æŸ¥å•†å“åº“å­˜",
            "arguments": {"item": "sunglasses"}  # ç®€åŒ–å¤„ç†
        })

    if "ä»·æ ¼" in user_request or "å¤šå°‘é’±" in user_request:
        plan.append({
            "step": 2,
            "tool": "get_price",
            "description": "æŸ¥è¯¢å•†å“ä»·æ ¼",
            "arguments": {"item": "sunglasses"}
        })

    if "è´­ä¹°" in user_request or "ä¹°" in user_request:
        plan.append({
            "step": 3,
            "tool": "process_purchase",
            "description": "å¤„ç†è´­ä¹°äº¤æ˜“",
            "arguments": {"item": "sunglasses", "quantity": 1}
        })

    return plan

def execute_plan(plan, available_tools):
    """
    æ‰§è¡Œè§„åˆ’æ­¥éª¤
    """
    print("ğŸ“‹ æ‰§è¡Œè§„åˆ’...")
    print("-" * 40)

    results = []
    for step in plan:
        tool_name = step["tool"]
        if tool_name in available_tools:
            print(f"æ­¥éª¤ {step['step']}: {step['description']}")
            print(f"  å·¥å…·: {tool_name}, å‚æ•°: {step['arguments']}")

            # æ‰§è¡Œå·¥å…·ï¼ˆè¿™é‡Œç”¨æ¨¡æ‹Ÿå‡½æ•°ï¼‰
            result = available_tools[tool_name](**step["arguments"])
            results.append(result)
            print(f"  ç»“æœ: {result}")
        else:
            print(f"âŒ é”™è¯¯: å·¥å…· {tool_name} ä¸å­˜åœ¨")

    print("-" * 40)
    return results

# æ¨¡æ‹Ÿå·¥å…·å‡½æ•°
def check_inventory(item):
    return f"{item} åº“å­˜: 10ä»¶"

def get_price(item):
    return f"{item} ä»·æ ¼: $99.99"

def process_purchase(item, quantity):
    return f"æˆåŠŸè´­ä¹° {quantity} ä»¶ {item}"

# è¿è¡Œå¿«é€Ÿç¤ºä¾‹
if __name__ == "__main__":
    # å®šä¹‰å¯ç”¨å·¥å…·
    tools = {
        "check_inventory": check_inventory,
        "get_price": get_price,
        "process_purchase": process_purchase
    }

    # æµ‹è¯•æ¡ˆä¾‹
    test_requests = [
        "ä½ ä»¬æœ‰å¤ªé˜³é•œåº“å­˜å—ï¼Ÿ",
        "å¤ªé˜³é•œå¤šå°‘é’±ï¼Ÿ",
        "æˆ‘æƒ³ä¹°ä¸€å‰¯å¤ªé˜³é•œ"
    ]

    for request in test_requests:
        print("\n" + "="*50)
        print(f"æµ‹è¯•è¯·æ±‚: {request}")

        # 1. ç”Ÿæˆè§„åˆ’
        plan = simple_planner(request, tools)
        print(f"ğŸ“ ç”Ÿæˆçš„è§„åˆ’: {json.dumps(plan, indent=2, ensure_ascii=False)}")

        # 2. æ‰§è¡Œè§„åˆ’
        results = execute_plan(plan, tools)

        # 3. æ€»ç»“ç»“æœ
        print(f"ğŸ“Š æ‰§è¡Œç»“æœ: {results}")

    print("\nğŸ’¡ å¿«é€Ÿè§„åˆ’ç¤ºä¾‹å®Œæˆï¼")
    print("ä¸‹ä¸€æ­¥ï¼š")
    print("1. å°†ç®€å•è§„åˆ™æ›¿æ¢ä¸ºçœŸæ­£çš„LLMè°ƒç”¨")
    print("2. å¢åŠ æ›´å¤šå·¥å…·å’Œå¤æ‚åœºæ™¯")
    print("3. ä½¿ç”¨ä¸‹é¢çš„å®Œæ•´è§„åˆ’æ¡†æ¶")
```

**è¿è¡Œè¿™ä¸ªå¿«é€Ÿç¤ºä¾‹**ï¼š
```bash
python quick_planning.py
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
==================================================
æµ‹è¯•è¯·æ±‚: ä½ ä»¬æœ‰å¤ªé˜³é•œåº“å­˜å—ï¼Ÿ
ğŸ” ç”¨æˆ·è¯·æ±‚: ä½ ä»¬æœ‰å¤ªé˜³é•œåº“å­˜å—ï¼Ÿ
ğŸ› ï¸  å¯ç”¨å·¥å…·: ['check_inventory', 'get_price', 'process_purchase']
ğŸ“ ç”Ÿæˆçš„è§„åˆ’: [
  {
    "step": 1,
    "tool": "check_inventory",
    "description": "æ£€æŸ¥å•†å“åº“å­˜",
    "arguments": {
      "item": "sunglasses"
    }
  }
]
ğŸ“‹ æ‰§è¡Œè§„åˆ’...
----------------------------------------
æ­¥éª¤ 1: æ£€æŸ¥å•†å“åº“å­˜
  å·¥å…·: check_inventory, å‚æ•°: {'item': 'sunglasses'}
  ç»“æœ: sunglasses åº“å­˜: 10ä»¶
----------------------------------------
ğŸ“Š æ‰§è¡Œç»“æœ: ['sunglasses åº“å­˜: 10ä»¶']
```

---

## 1. å·¥ä½œæµè§„åˆ’å®ç°

### 1.1 ç¯å¢ƒå‡†å¤‡
```bash
# å®‰è£…å¿…è¦çš„åº“
pip install openai python-dotenv
```

### 1.2 å®Œæ•´ä»£ç ç¤ºä¾‹
åˆ›å»ºæ–‡ä»¶ `workflow_planner.py`ï¼š

```python
# workflow_planner.py
"""
å·¥ä½œæµè§„åˆ’å®ç° - è®©LLMç”¨è‡ªç„¶è¯­è¨€æè¿°è®¡åˆ’æ­¥éª¤
"""

import os
from openai import OpenAI
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# æ¨¡æ‹Ÿå·¥å…·å‡½æ•°
def get_item_descriptions(keyword):
    """è·å–å•†å“æè¿°"""
    items = [
        {"id": "SG001", "name": "Aviator", "description": "ç»å…¸é£è¡Œå‘˜æ¬¾å¼ï¼Œé‡‘å±é•œæ¡†"},
        {"id": "SG005", "name": "Classic", "description": "ç»å…¸åœ†å½¢è½®å»“ï¼Œç®€çº¦é‡‘å±é•œæ¡†"},
        {"id": "SG008", "name": "Wayfarer", "description": "æ—…è¡Œè€…æ¬¾å¼ï¼Œå¡‘æ–™é•œæ¡†"}
    ]
    # ç®€å•å…³é”®è¯åŒ¹é…
    matched = [item for item in items if keyword.lower() in item["description"].lower()]
    return matched

def check_inventory(item_id):
    """æ£€æŸ¥åº“å­˜"""
    inventory = {
        "SG001": 23,
        "SG005": 10,
        "SG008": 15
    }
    return inventory.get(item_id, 0)

def get_item_price(item_id):
    """è·å–ä»·æ ¼"""
    prices = {
        "SG001": 80.0,
        "SG005": 60.0,
        "SG008": 120.0
    }
    return prices.get(item_id, 0.0)

def generate_workflow_plan(user_request):
    """
    ç”Ÿæˆå·¥ä½œæµè§„åˆ’ - LLMç”¨è‡ªç„¶è¯­è¨€æè¿°è®¡åˆ’æ­¥éª¤
    """
    system_prompt = """ä½ æ˜¯ä¸€ä¸ªå®¢æœåŠ©ç†ï¼Œéœ€è¦å›ç­”å®¢æˆ·çš„å¤æ‚æŸ¥è¯¢ã€‚
ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š
1. get_item_descriptions(keyword): æ ¹æ®å…³é”®è¯æŸ¥æ‰¾å•†å“
2. check_inventory(item_id): æ£€æŸ¥å•†å“åº“å­˜
3. get_item_price(item_id): æŸ¥è¯¢å•†å“ä»·æ ¼

è¯·æ ¹æ®ç”¨æˆ·è¯·æ±‚ï¼Œæè¿°ä½ å°†å¦‚ä½•ä¸€æ­¥æ­¥ä½¿ç”¨è¿™äº›å·¥å…·æ¥å›ç­”é—®é¢˜ã€‚
ç”¨è‡ªç„¶è¯­è¨€æè¿°ä½ çš„è®¡åˆ’æ­¥éª¤ã€‚"""

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_request}
        ],
        temperature=0.7
    )

    return response.choices[0].message.content

def execute_workflow_plan(plan_text, user_request):
    """
    è§£æå¹¶æ‰§è¡Œå·¥ä½œæµè§„åˆ’
    æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…éœ€è¦æ›´å¤æ‚çš„è‡ªç„¶è¯­è¨€è§£æ
    """
    print("ğŸ“‹ æ‰§è¡Œå·¥ä½œæµè§„åˆ’:")
    print("-" * 40)
    print(plan_text)
    print("-" * 40)

    # ç®€åŒ–æ‰§è¡Œï¼šæ ¹æ®å¸¸è§æ¨¡å¼æ‰§è¡Œ
    results = []

    if "åœ†å½¢" in user_request or "round" in user_request.lower():
        # æ­¥éª¤1: æŸ¥æ‰¾åœ†å½¢å¤ªé˜³é•œ
        print("æ­¥éª¤1: æŸ¥æ‰¾åœ†å½¢å¤ªé˜³é•œ")
        items = get_item_descriptions("åœ†å½¢")
        if not items:
            items = get_item_descriptions("round")
        print(f"  æ‰¾åˆ°å•†å“: {[item['name'] for item in items]}")
        results.append(items)

        # æ­¥éª¤2: æ£€æŸ¥åº“å­˜
        print("æ­¥éª¤2: æ£€æŸ¥åº“å­˜")
        for item in items:
            stock = check_inventory(item["id"])
            print(f"  {item['name']} åº“å­˜: {stock}ä»¶")
            item["stock"] = stock
            results.append(f"{item['name']}åº“å­˜:{stock}")

        # æ­¥éª¤3: æ£€æŸ¥ä»·æ ¼
        print("æ­¥éª¤3: æ£€æŸ¥ä»·æ ¼")
        for item in items:
            price = get_item_price(item["id"])
            print(f"  {item['name']} ä»·æ ¼: ${price}")
            item["price"] = price
            results.append(f"{item['name']}ä»·æ ¼:${price}")

            # æ­¥éª¤4: ç­›é€‰ä½äº100ç¾å…ƒçš„å•†å“
            if price < 100:
                print(f"  âœ… {item['name']} ä»·æ ¼ä½äº$100")
                results.append(f"{item['name']}ç¬¦åˆæ¡ä»¶")

    return results

def main():
    """ä¸»å‡½æ•°"""
    # æµ‹è¯•è¯·æ±‚
    user_request = "ä½ ä»¬æœ‰æ²¡æœ‰åº“å­˜ä¸­å”®ä»·ä½äº100ç¾å…ƒçš„åœ†å½¢å¤ªé˜³çœ¼é•œï¼Ÿ"

    print("=" * 60)
    print(f"ç”¨æˆ·è¯·æ±‚: {user_request}")
    print("=" * 60)

    # 1. ç”Ÿæˆå·¥ä½œæµè§„åˆ’
    print("\nğŸ§  ç”Ÿæˆå·¥ä½œæµè§„åˆ’...")
    plan = generate_workflow_plan(user_request)

    # 2. æ‰§è¡Œè§„åˆ’
    print("\nâš¡ æ‰§è¡Œè§„åˆ’...")
    results = execute_workflow_plan(plan, user_request)

    # 3. è¾“å‡ºæ€»ç»“
    print("\nğŸ“Š æ‰§è¡Œç»“æœæ€»ç»“:")
    for result in results:
        if isinstance(result, str):
            print(f"  â€¢ {result}")

    print("\nğŸ’¡ å·¥ä½œæµè§„åˆ’å®Œæˆ!")
    print("æ³¨æ„: è¿™æ˜¯ç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…éœ€è¦è‡ªç„¶è¯­è¨€è§£ææ¥å‡†ç¡®æ‰§è¡Œè®¡åˆ’")

if __name__ == "__main__":
    main()
```

### 1.3 è¿è¡Œç¤ºä¾‹
```bash
python workflow_planner.py
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
============================================================
ç”¨æˆ·è¯·æ±‚: ä½ ä»¬æœ‰æ²¡æœ‰åº“å­˜ä¸­å”®ä»·ä½äº100ç¾å…ƒçš„åœ†å½¢å¤ªé˜³çœ¼é•œï¼Ÿ
============================================================

ğŸ§  ç”Ÿæˆå·¥ä½œæµè§„åˆ’...
æˆ‘å°†æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ¥å›ç­”æ‚¨çš„é—®é¢˜ï¼š

1. é¦–å…ˆï¼Œæˆ‘ä¼šä½¿ç”¨ `get_item_descriptions` å·¥å…·ï¼Œä»¥å…³é”®è¯"åœ†å½¢"æ¥æœç´¢æˆ‘ä»¬çš„å¤ªé˜³é•œäº§å“ç›®å½•ï¼Œæ‰¾å‡ºæ‰€æœ‰åœ†å½¢æ¬¾å¼çš„å¤ªé˜³é•œã€‚

2. å¯¹äºæ‰¾åˆ°çš„æ¯ä¸€æ¬¾åœ†å½¢å¤ªé˜³é•œï¼Œæˆ‘ä¼šä½¿ç”¨ `check_inventory` å·¥å…·æ£€æŸ¥å®ƒä»¬çš„åº“å­˜æ•°é‡ï¼Œç¡®ä¿æœ‰è´§ã€‚

3. æ¥ç€ï¼Œæˆ‘ä¼šä½¿ç”¨ `get_item_price` å·¥å…·æŸ¥è¯¢æ¯ä¸€æ¬¾æœ‰åº“å­˜çš„åœ†å½¢å¤ªé˜³é•œçš„ä»·æ ¼ã€‚

4. æœ€åï¼Œæˆ‘ä¼šç­›é€‰å‡ºä»·æ ¼ä½äº100ç¾å…ƒçš„æ¬¾å¼ï¼Œå¹¶æ•´ç†å‡ºè¿™äº›ç¬¦åˆæ¡ä»¶çš„å•†å“ä¿¡æ¯ï¼ŒåŒ…æ‹¬åç§°ã€æè¿°ã€åº“å­˜æ•°é‡å’Œä»·æ ¼ï¼Œç„¶åå‘æ‚¨æ±‡æŠ¥ç»“æœã€‚

âš¡ æ‰§è¡Œè§„åˆ’...
ğŸ“‹ æ‰§è¡Œå·¥ä½œæµè§„åˆ’:
----------------------------------------
æˆ‘å°†æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ¥å›ç­”æ‚¨çš„é—®é¢˜ï¼š

1. é¦–å…ˆï¼Œæˆ‘ä¼šä½¿ç”¨ `get_item_descriptions` å·¥å…·ï¼Œä»¥å…³é”®è¯"åœ†å½¢"æ¥æœç´¢æˆ‘ä»¬çš„å¤ªé˜³é•œäº§å“ç›®å½•ï¼Œæ‰¾å‡ºæ‰€æœ‰åœ†å½¢æ¬¾å¼çš„å¤ªé˜³é•œã€‚

2. å¯¹äºæ‰¾åˆ°çš„æ¯ä¸€æ¬¾åœ†å½¢å¤ªé˜³é•œï¼Œæˆ‘ä¼šä½¿ç”¨ `check_inventory` å·¥å…·æ£€æŸ¥å®ƒä»¬çš„åº“å­˜æ•°é‡ï¼Œç¡®ä¿æœ‰è´§ã€‚

3. æ¥ç€ï¼Œæˆ‘ä¼šä½¿ç”¨ `get_item_price` å·¥å…·æŸ¥è¯¢æ¯ä¸€æ¬¾æœ‰åº“å­˜çš„åœ†å½¢å¤ªé˜³é•œçš„ä»·æ ¼ã€‚

4. æœ€åï¼Œæˆ‘ä¼šç­›é€‰å‡ºä»·æ ¼ä½äº100ç¾å…ƒçš„æ¬¾å¼ï¼Œå¹¶æ•´ç†å‡ºè¿™äº›ç¬¦åˆæ¡ä»¶çš„å•†å“ä¿¡æ¯ï¼ŒåŒ…æ‹¬åç§°ã€æè¿°ã€åº“å­˜æ•°é‡å’Œä»·æ ¼ï¼Œç„¶åå‘æ‚¨æ±‡æŠ¥ç»“æœã€‚
----------------------------------------
æ­¥éª¤1: æŸ¥æ‰¾åœ†å½¢å¤ªé˜³é•œ
  æ‰¾åˆ°å•†å“: ['Classic']
æ­¥éª¤2: æ£€æŸ¥åº“å­˜
  Classic åº“å­˜: 10ä»¶
æ­¥éª¤3: æ£€æŸ¥ä»·æ ¼
  Classic ä»·æ ¼: $60.0
  âœ… Classic ä»·æ ¼ä½äº$100

ğŸ“Š æ‰§è¡Œç»“æœæ€»ç»“:
  â€¢ Classicåº“å­˜:10
  â€¢ Classicä»·æ ¼:$60.0
  â€¢ Classicç¬¦åˆæ¡ä»¶

ğŸ’¡ å·¥ä½œæµè§„åˆ’å®Œæˆ!
æ³¨æ„: è¿™æ˜¯ç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…éœ€è¦è‡ªç„¶è¯­è¨€è§£ææ¥å‡†ç¡®æ‰§è¡Œè®¡åˆ’
```

### 1.4 ä¼˜ç¼ºç‚¹åˆ†æ
**ä¼˜ç‚¹**ï¼š
- âœ… ç›´è§‚æ˜“æ‡‚ï¼šLLMç”¨è‡ªç„¶è¯­è¨€æè¿°è®¡åˆ’ï¼Œäººç±»å¯è¯»
- âœ… çµæ´»æ€§é«˜ï¼šå¯ä»¥å¤„ç†å„ç§å¤æ‚æŸ¥è¯¢
- âœ… å¼€å‘ç®€å•ï¼šä¸éœ€è¦å¤æ‚çš„è§£æå™¨

**ç¼ºç‚¹**ï¼š
- âŒ æ‰§è¡Œå›°éš¾ï¼šè‡ªç„¶è¯­è¨€è®¡åˆ’éš¾ä»¥è‡ªåŠ¨è§£æå’Œæ‰§è¡Œ
- âŒ å¯é æ€§ä½ï¼šLLMå¯èƒ½ç”Ÿæˆä¸å¯æ‰§è¡Œçš„è®¡åˆ’
- âŒ æ•ˆç‡ä½ä¸‹ï¼šéœ€è¦äººå·¥æˆ–å¤æ‚NLPæ¥ç†è§£è®¡åˆ’

---

## 2. ç»“æ„åŒ–è¾“å‡ºè§„åˆ’å®ç°

### 2.1 ç¯å¢ƒå‡†å¤‡
```bash
# å®‰è£…å¿…è¦çš„åº“
pip install openai python-dotenv
```

### 2.2 å®Œæ•´ä»£ç ç¤ºä¾‹
åˆ›å»ºæ–‡ä»¶ `structured_planner.py`ï¼š

```python
# structured_planner.py
"""
ç»“æ„åŒ–è¾“å‡ºè§„åˆ’å®ç° - LLMç”¨JSONæ ¼å¼è¾“å‡ºå¯è§£æçš„æ‰§è¡Œè®¡åˆ’
"""

import os
import json
from openai import OpenAI
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# æ¨¡æ‹Ÿå·¥å…·å‡½æ•°
def get_item_descriptions(keyword):
    """è·å–å•†å“æè¿°"""
    items = [
        {"id": "SG001", "name": "Aviator", "description": "ç»å…¸é£è¡Œå‘˜æ¬¾å¼ï¼Œé‡‘å±é•œæ¡†", "shape": "é£è¡Œå‘˜"},
        {"id": "SG005", "name": "Classic", "description": "ç»å…¸åœ†å½¢è½®å»“ï¼Œç®€çº¦é‡‘å±é•œæ¡†", "shape": "åœ†å½¢"},
        {"id": "SG008", "name": "Wayfarer", "description": "æ—…è¡Œè€…æ¬¾å¼ï¼Œå¡‘æ–™é•œæ¡†", "shape": "æ–¹å½¢"}
    ]
    # ç®€å•å…³é”®è¯åŒ¹é…
    matched = [item for item in items if keyword.lower() in item["description"].lower()]
    return matched

def check_inventory(item_id):
    """æ£€æŸ¥åº“å­˜"""
    inventory = {
        "SG001": 23,
        "SG005": 10,
        "SG008": 15
    }
    return inventory.get(item_id, 0)

def get_item_price(item_id):
    """è·å–ä»·æ ¼"""
    prices = {
        "SG001": 80.0,
        "SG005": 60.0,
        "SG008": 120.0
    }
    return prices.get(item_id, 0.0)

def generate_structured_plan(user_request):
    """
    ç”Ÿæˆç»“æ„åŒ–è§„åˆ’ - LLMç”¨JSONæ ¼å¼è¾“å‡ºè®¡åˆ’
    """
    system_prompt = """ä½ æ˜¯ä¸€ä¸ªå®¢æœåŠ©ç†ï¼Œéœ€è¦å›ç­”å®¢æˆ·çš„å¤æ‚æŸ¥è¯¢ã€‚
ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š
1. get_item_descriptions(keyword): æ ¹æ®å…³é”®è¯æŸ¥æ‰¾å•†å“ï¼Œè¿”å›å•†å“åˆ—è¡¨
2. check_inventory(item_id): æ£€æŸ¥å•†å“åº“å­˜ï¼Œè¿”å›åº“å­˜æ•°é‡
3. get_item_price(item_id): æŸ¥è¯¢å•†å“ä»·æ ¼ï¼Œè¿”å›ä»·æ ¼

è¯·æ ¹æ®ç”¨æˆ·è¯·æ±‚ï¼Œåˆ›å»ºä¸€ä¸ªJSONæ ¼å¼çš„åˆ†æ­¥æ‰§è¡Œè®¡åˆ’ã€‚
JSONæ ¼å¼è¦æ±‚ï¼š
[
  {
    "step": 1,
    "description": "æ­¥éª¤æè¿°",
    "tool": "å·¥å…·åç§°",
    "arguments": {"å‚æ•°å": "å‚æ•°å€¼"}
  },
  ...
]

åªè¿”å›JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡æœ¬ã€‚"""

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_request}
        ],
        temperature=0.3,  # è¾ƒä½æ¸©åº¦ä»¥è·å¾—æ›´ç¨³å®šçš„JSONè¾“å‡º
        response_format={"type": "json_object"}
    )

    return response.choices[0].message.content

def parse_and_execute_plan(plan_json):
    """
    è§£æå¹¶æ‰§è¡Œç»“æ„åŒ–è§„åˆ’
    """
    try:
        plan = json.loads(plan_json)
        if not isinstance(plan, list):
            plan = [plan]  # å¦‚æœæ˜¯å•ä¸ªå¯¹è±¡ï¼Œè½¬ä¸ºåˆ—è¡¨

        print("ğŸ“‹ è§£æåˆ°çš„è®¡åˆ’:")
        print(json.dumps(plan, indent=2, ensure_ascii=False))
        print("-" * 40)

        results = []
        for step in plan:
            step_num = step.get("step", len(results) + 1)
            description = step.get("description", "")
            tool_name = step.get("tool", "")
            arguments = step.get("arguments", {})

            print(f"æ­¥éª¤ {step_num}: {description}")
            print(f"  å·¥å…·: {tool_name}, å‚æ•°: {arguments}")

            # æ‰§è¡Œå·¥å…·
            if tool_name == "get_item_descriptions":
                keyword = arguments.get("keyword", "")
                result = get_item_descriptions(keyword)
                print(f"  ç»“æœ: æ‰¾åˆ°{len(result)}ä¸ªå•†å“")
                results.append({"step": step_num, "result": result})

            elif tool_name == "check_inventory":
                item_id = arguments.get("item_id", "")
                result = check_inventory(item_id)
                print(f"  ç»“æœ: åº“å­˜{result}ä»¶")
                results.append({"step": step_num, "result": result})

            elif tool_name == "get_item_price":
                item_id = arguments.get("item_id", "")
                result = get_item_price(item_id)
                print(f"  ç»“æœ: ${result}")
                results.append({"step": step_num, "result": result})

            else:
                print(f"  âš ï¸ æœªçŸ¥å·¥å…·: {tool_name}")
                results.append({"step": step_num, "error": f"æœªçŸ¥å·¥å…·: {tool_name}"})

        return results

    except json.JSONDecodeError as e:
        print(f"âŒ JSONè§£æé”™è¯¯: {e}")
        print(f"åŸå§‹å“åº”: {plan_json}")
        return []

def main():
    """ä¸»å‡½æ•°"""
    # æµ‹è¯•è¯·æ±‚
    user_request = "ä½ ä»¬æœ‰æ²¡æœ‰åº“å­˜ä¸­å”®ä»·ä½äº100ç¾å…ƒçš„åœ†å½¢å¤ªé˜³çœ¼é•œï¼Ÿ"

    print("=" * 60)
    print(f"ç”¨æˆ·è¯·æ±‚: {user_request}")
    print("=" * 60)

    # 1. ç”Ÿæˆç»“æ„åŒ–è§„åˆ’
    print("\nğŸ§  ç”Ÿæˆç»“æ„åŒ–è§„åˆ’...")
    plan_json = generate_structured_plan(user_request)
    print(f"åŸå§‹JSONå“åº”:\n{plan_json}")

    # 2. è§£æå¹¶æ‰§è¡Œè§„åˆ’
    print("\nâš¡ è§£æå¹¶æ‰§è¡Œè§„åˆ’...")
    results = parse_and_execute_plan(plan_json)

    # 3. è¾“å‡ºæ€»ç»“
    print("\nğŸ“Š æ‰§è¡Œç»“æœæ€»ç»“:")
    for item in results:
        if "error" in item:
            print(f"  æ­¥éª¤ {item['step']}: âŒ {item['error']}")
        else:
            result = item['result']
            if isinstance(result, list):
                print(f"  æ­¥éª¤ {item['step']}: âœ… æ‰¾åˆ°{len(result)}ä¸ªå•†å“")
                for product in result:
                    print(f"      â€¢ {product['name']} (ID: {product['id']})")
            elif isinstance(result, (int, float)):
                print(f"  æ­¥éª¤ {item['step']}: âœ… ç»“æœ: {result}")
            else:
                print(f"  æ­¥éª¤ {item['step']}: âœ… ç»“æœ: {result}")

    print("\nğŸ’¡ ç»“æ„åŒ–è¾“å‡ºè§„åˆ’å®Œæˆ!")
    print("ä¼˜ç‚¹: JSONæ ¼å¼æ˜“äºè§£æï¼Œæ‰§è¡Œå¯é ")
    print("ç¼ºç‚¹: éœ€è¦ä¸¥æ ¼çš„æ ¼å¼çº¦æŸï¼ŒLLMå¯èƒ½ç”Ÿæˆæ— æ•ˆJSON")

if __name__ == "__main__":
    main()
```

### 2.3 è¿è¡Œç¤ºä¾‹
```bash
python structured_planner.py
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
============================================================
ç”¨æˆ·è¯·æ±‚: ä½ ä»¬æœ‰æ²¡æœ‰åº“å­˜ä¸­å”®ä»·ä½äº100ç¾å…ƒçš„åœ†å½¢å¤ªé˜³çœ¼é•œï¼Ÿ
============================================================

ğŸ§  ç”Ÿæˆç»“æ„åŒ–è§„åˆ’...
åŸå§‹JSONå“åº”:
{
  "plan": [
    {
      "step": 1,
      "description": "ä½¿ç”¨å…³é”®è¯'åœ†å½¢'æœç´¢å¤ªé˜³é•œå•†å“",
      "tool": "get_item_descriptions",
      "arguments": {
        "keyword": "åœ†å½¢"
      }
    },
    {
      "step": 2,
      "description": "æ£€æŸ¥æ‰¾åˆ°çš„å•†å“çš„åº“å­˜æ•°é‡",
      "tool": "check_inventory",
      "arguments": {
        "item_id": "SG005"
      }
    },
    {
      "step": 3,
      "description": "æŸ¥è¯¢å•†å“ä»·æ ¼",
      "tool": "get_item_price",
      "arguments": {
        "item_id": "SG005"
      }
    }
  ]
}

âš¡ è§£æå¹¶æ‰§è¡Œè§„åˆ’...
ğŸ“‹ è§£æåˆ°çš„è®¡åˆ’:
[
  {
    "step": 1,
    "description": "ä½¿ç”¨å…³é”®è¯'åœ†å½¢'æœç´¢å¤ªé˜³é•œå•†å“",
    "tool": "get_item_descriptions",
    "arguments": {
      "keyword": "åœ†å½¢"
    }
  },
  {
    "step": 2,
    "description": "æ£€æŸ¥æ‰¾åˆ°çš„å•†å“çš„åº“å­˜æ•°é‡",
    "tool": "check_inventory",
    "arguments": {
      "item_id": "SG005"
    }
  },
  {
    "step": 3,
    "description": "æŸ¥è¯¢å•†å“ä»·æ ¼",
    "tool": "get_item_price",
    "arguments": {
      "item_id": "SG005"
    }
  }
]
----------------------------------------
æ­¥éª¤ 1: ä½¿ç”¨å…³é”®è¯'åœ†å½¢'æœç´¢å¤ªé˜³é•œå•†å“
  å·¥å…·: get_item_descriptions, å‚æ•°: {'keyword': 'åœ†å½¢'}
  ç»“æœ: æ‰¾åˆ°1ä¸ªå•†å“
æ­¥éª¤ 2: æ£€æŸ¥æ‰¾åˆ°çš„å•†å“çš„åº“å­˜æ•°é‡
  å·¥å…·: check_inventory, å‚æ•°: {'item_id': 'SG005'}
  ç»“æœ: åº“å­˜10ä»¶
æ­¥éª¤ 3: æŸ¥è¯¢å•†å“ä»·æ ¼
  å·¥å…·: get_item_price, å‚æ•°: {'item_id': 'SG005'}
  ç»“æœ: $60.0

ğŸ“Š æ‰§è¡Œç»“æœæ€»ç»“:
  æ­¥éª¤ 1: âœ… æ‰¾åˆ°1ä¸ªå•†å“
      â€¢ Classic (ID: SG005)
  æ­¥éª¤ 2: âœ… ç»“æœ: 10
  æ­¥éª¤ 3: âœ… ç»“æœ: 60.0

ğŸ’¡ ç»“æ„åŒ–è¾“å‡ºè§„åˆ’å®Œæˆ!
ä¼˜ç‚¹: JSONæ ¼å¼æ˜“äºè§£æï¼Œæ‰§è¡Œå¯é 
ç¼ºç‚¹: éœ€è¦ä¸¥æ ¼çš„æ ¼å¼çº¦æŸï¼ŒLLMå¯èƒ½ç”Ÿæˆæ— æ•ˆJSON
```

### 2.4 ä¼˜ç¼ºç‚¹åˆ†æ
**ä¼˜ç‚¹**ï¼š
- âœ… **æ˜“äºè§£æ**ï¼šJSONæ ¼å¼å¯ä»¥è¢«ä»£ç ç›´æ¥è§£æå’Œæ‰§è¡Œ
- âœ… **æ‰§è¡Œå¯é **ï¼šæ˜ç¡®çš„å·¥å…·å’Œå‚æ•°ï¼Œå‡å°‘æ­§ä¹‰
- âœ… **ä¾¿äºè°ƒè¯•**ï¼šå¯ä»¥è®°å½•å’Œå®¡æŸ¥å®Œæ•´çš„æ‰§è¡Œè®¡åˆ’
- âœ… **å¯æ‰©å±•æ€§**ï¼šå¯ä»¥æ·»åŠ æ›´å¤šå­—æ®µï¼ˆå¦‚æ¡ä»¶åˆ¤æ–­ã€å¾ªç¯ç­‰ï¼‰

**ç¼ºç‚¹**ï¼š
- âŒ **æ ¼å¼çº¦æŸ**ï¼šéœ€è¦LLMä¸¥æ ¼éµå®ˆJSONæ ¼å¼
- âŒ **çµæ´»æ€§æœ‰é™**ï¼šå›ºå®šçš„ç»“æ„å¯èƒ½ä¸é€‚åˆæ‰€æœ‰åœºæ™¯
- âŒ **é”™è¯¯å¤„ç†**ï¼šJSONè§£æå¤±è´¥æ—¶éœ€è¦é¢å¤–å¤„ç†
- âŒ **æç¤ºè¯å¤æ‚**ï¼šéœ€è¦è¯¦ç»†çš„æ ¼å¼è¯´æ˜

### 2.5 æ”¹è¿›å»ºè®®
1. **ä½¿ç”¨JSON Schema**ï¼šå®šä¹‰æ›´ä¸¥æ ¼çš„JSONç»“æ„çº¦æŸ
2. **æ·»åŠ éªŒè¯**ï¼šåœ¨è§£æå‰éªŒè¯JSONæ ¼å¼å’Œå¿…å¡«å­—æ®µ
3. **æ”¯æŒåµŒå¥—**ï¼šå…è®¸è®¡åˆ’ä¸­åŒ…å«æ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯
4. **é”™è¯¯æ¢å¤**ï¼šå½“JSONè§£æå¤±è´¥æ—¶ï¼Œå°è¯•ä¿®å¤æˆ–é‡æ–°ç”Ÿæˆ

---

## 3. ä»£ç æ‰§è¡Œè§„åˆ’å®ç°

### 3.1 ç¯å¢ƒå‡†å¤‡
```bash
# å®‰è£…å¿…è¦çš„åº“
pip install openai python-dotenv tinydb  # æ·»åŠ tinydbç”¨äºæ•°æ®åº“æ“ä½œ
```

### 3.2 å®Œæ•´ä»£ç ç¤ºä¾‹
åˆ›å»ºæ–‡ä»¶ `code_execution_planner.py`ï¼š

```python
# code_execution_planner.py
"""
ä»£ç æ‰§è¡Œè§„åˆ’å®ç° - LLMç›´æ¥ç¼–å†™ä»£ç ä½œä¸ºè®¡åˆ’
"""

import os
import json
import re
import sys
import io
import traceback
from openai import OpenAI
from dotenv import load_dotenv
from tinydb import TinyDB, Query

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# åˆå§‹åŒ–TinyDBæ•°æ®åº“
db = TinyDB('sunglasses_db.json')
inventory_tbl = db.table('inventory')
transactions_tbl = db.table('transactions')

def setup_database():
    """è®¾ç½®ç¤ºä¾‹æ•°æ®åº“"""
    # æ¸…ç©ºç°æœ‰æ•°æ®
    db.drop_tables()

    # åˆ›å»ºåº“å­˜è¡¨
    inventory_items = [
        {
            "item_id": "SG001",
            "name": "Aviator",
            "description": "ç»å…¸é£è¡Œå‘˜æ¬¾å¼ï¼Œé‡‘å±é•œæ¡†ï¼Œé€‚åˆå„ç§è„¸å‹",
            "quantity_in_stock": 23,
            "price": 80.0,
            "shape": "é£è¡Œå‘˜",
            "color": "é‡‘è‰²/é»‘è‰²"
        },
        {
            "item_id": "SG005",
            "name": "Classic",
            "description": "ç»å…¸åœ†å½¢è½®å»“ï¼Œç®€çº¦é‡‘å±é•œæ¡†ï¼Œæ°¸æ’é£æ ¼",
            "quantity_in_stock": 10,
            "price": 60.0,
            "shape": "åœ†å½¢",
            "color": "é“¶è‰²"
        },
        {
            "item_id": "SG008",
            "name": "Wayfarer",
            "description": "æ—…è¡Œè€…æ¬¾å¼ï¼Œå¡‘æ–™é•œæ¡†ï¼Œå¤å¤æ—¶å°š",
            "quantity_in_stock": 15,
            "price": 120.0,
            "shape": "æ–¹å½¢",
            "color": "é»‘è‰²/ç³ç‘è‰²"
        }
    ]

    # åˆ›å»ºäº¤æ˜“è¡¨ï¼ˆæœŸåˆä½™é¢ï¼‰
    transactions = [
        {
            "transaction_id": "TXN001",
            "customer_name": "OPENING_BALANCE",
            "transaction_summary": "æœŸåˆä½™é¢",
            "transaction_amount": 0.0,
            "balance_after_transaction": 500.0,
            "timestamp": "2025-01-01T09:00:00"
        }
    ]

    # æ’å…¥æ•°æ®
    inventory_tbl.insert_multiple(inventory_items)
    transactions_tbl.insert_multiple(transactions)

    return db, inventory_tbl, transactions_tbl

def get_current_balance():
    """è·å–å½“å‰ä½™é¢"""
    latest = transactions_tbl.all()
    if latest:
        return latest[-1].get('balance_after_transaction', 0.0)
    return 0.0

def next_transaction_id(prefix="TXN"):
    """ç”Ÿæˆä¸‹ä¸€ä¸ªäº¤æ˜“ID"""
    transactions = transactions_tbl.all()
    if not transactions:
        return f"{prefix}001"

    last_id = transactions[-1].get('transaction_id', f"{prefix}000")
    match = re.search(r'\d+', last_id)
    if match:
        num = int(match.group())
        return f"{prefix}{num+1:03d}"
    return f"{prefix}001"

def generate_code_plan(user_request):
    """
    ç”Ÿæˆä»£ç æ‰§è¡Œè§„åˆ’ - LLMç›´æ¥ç¼–å†™Pythonä»£ç 
    """
    # æ„å»ºæ•°æ®åº“æ¨¡å¼æè¿°
    schema_block = f"""
æ•°æ®åº“æ¨¡å¼:
1. åº“å­˜è¡¨ (inventory_tbl):
   - item_id (str): å•†å“ID
   - name (str): å•†å“åç§°
   - description (str): å•†å“æè¿°
   - quantity_in_stock (int): åº“å­˜æ•°é‡
   - price (float): ä»·æ ¼
   - shape (str): å½¢çŠ¶
   - color (str): é¢œè‰²

2. äº¤æ˜“è¡¨ (transactions_tbl):
   - transaction_id (str): äº¤æ˜“ID
   - customer_name (str): å®¢æˆ·åç§°
   - transaction_summary (str): äº¤æ˜“æ‘˜è¦
   - transaction_amount (float): äº¤æ˜“é‡‘é¢
   - balance_after_transaction (float): äº¤æ˜“åä½™é¢
   - timestamp (str): æ—¶é—´æˆ³

å¯ç”¨å˜é‡:
- db: TinyDBæ•°æ®åº“å¯¹è±¡
- inventory_tbl: åº“å­˜è¡¨
- transactions_tbl: äº¤æ˜“è¡¨
- Query: TinyDBæŸ¥è¯¢å¯¹è±¡
- get_current_balance(): è·å–å½“å‰ä½™é¢å‡½æ•°
- next_transaction_id(): ç”Ÿæˆä¸‹ä¸€ä¸ªäº¤æ˜“IDå‡½æ•°

å½“å‰ä½™é¢: ${get_current_balance():.2f}
"""

    system_prompt = f"""ä½ æ˜¯ä¸€åé«˜çº§æ•°æ®åŠ©æ‰‹ï¼Œé€šè¿‡ç¼–å†™Pythonä»£ç æ¥å›ç­”ç”¨æˆ·æŸ¥è¯¢ã€‚
ä½ å¯ä»¥è®¿é—®ä»¥ä¸‹æ•°æ®åº“å’Œå‡½æ•°ï¼š

{schema_block}

ç¼–å†™è§„åˆ™ï¼š
1. æ ¹æ®ç”¨æˆ·è¯·æ±‚ç¼–å†™å®Œæ•´çš„Pythonä»£ç 
2. ä»£ç å¿…é¡»åŒ…å«åœ¨<execute_python>æ ‡ç­¾ä¸­
3. ä»£ç åº”è¯¥ï¼š
   - è§£æç”¨æˆ·è¯·æ±‚ä¸­çš„æ¡ä»¶
   - ä½¿ç”¨Query()æ„å»ºæ•°æ®åº“æŸ¥è¯¢
   - å¤„ç†æŸ¥è¯¢ç»“æœå¹¶ç”Ÿæˆç­”æ¡ˆ
   - è®¾ç½®answer_textå˜é‡ä½œä¸ºæœ€ç»ˆå›ç­”
   - è®¾ç½®STATUSå˜é‡ï¼ˆsuccess, no_match, insufficient_stockç­‰ï¼‰
4. å¦‚æœæ˜¯è´­ä¹°/é€€è´§æ“ä½œï¼Œéœ€è¦ï¼š
   - æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
   - æ›´æ–°åº“å­˜æ•°é‡
   - åˆ›å»ºäº¤æ˜“è®°å½•
   - æ›´æ–°ä½™é¢
5. ä¿æŒä»£ç ç®€æ´ï¼Œæ·»åŠ å¿…è¦çš„æ³¨é‡Š

åªè¿”å›<execute_python>æ ‡ç­¾å†…çš„ä»£ç ï¼Œä¸è¦æœ‰å…¶ä»–æ–‡æœ¬ã€‚"""

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_request}
        ],
        temperature=0.3
    )

    return response.choices[0].message.content

def extract_and_execute_code(code_content, user_request):
    """
    æå–å¹¶æ‰§è¡Œä»£ç 
    """
    print("ğŸ” æå–ä»£ç ...")

    # æå–<execute_python>æ ‡ç­¾å†…çš„ä»£ç 
    match = re.search(r'<execute_python>(.*?)</execute_python>', code_content, re.DOTALL)
    if not match:
        print("âŒ æœªæ‰¾åˆ°<execute_python>æ ‡ç­¾")
        return None

    code = match.group(1).strip()
    print(f"æå–çš„ä»£ç é•¿åº¦: {len(code)}å­—ç¬¦")

    # å‡†å¤‡æ‰§è¡Œç¯å¢ƒ
    safe_globals = {
        'db': db,
        'inventory_tbl': inventory_tbl,
        'transactions_tbl': transactions_tbl,
        'Query': Query,
        'get_current_balance': get_current_balance,
        'next_transaction_id': next_transaction_id,
        'user_request': user_request
    }

    safe_locals = {}

    # æ•è·è¾“å‡º
    old_stdout = sys.stdout
    sys.stdout = io.StringIO()

    try:
        print("âš¡ æ‰§è¡Œä»£ç ...")
        exec(code, safe_globals, safe_locals)
        output = sys.stdout.getvalue()
    except Exception as e:
        output = f"æ‰§è¡Œé”™è¯¯: {str(e)}\n{traceback.format_exc()}"
    finally:
        sys.stdout = old_stdout

    # è·å–ç»“æœ
    answer_text = safe_locals.get('answer_text', 'æœªè®¾ç½®answer_text')
    status = safe_locals.get('STATUS', 'unknown')

    return {
        'code': code,
        'output': output,
        'answer_text': answer_text,
        'status': status,
        'locals': safe_locals
    }

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸ¤– ä»£ç æ‰§è¡Œè§„åˆ’ç³»ç»Ÿ")
    print("=" * 60)

    # è®¾ç½®æ•°æ®åº“
    print("ğŸ—„ï¸  è®¾ç½®æ•°æ®åº“...")
    setup_database()

    # æµ‹è¯•æ¡ˆä¾‹
    test_cases = [
        "ä½ ä»¬æ˜¯å¦æœ‰åº“å­˜ä¸­çš„åœ†å½¢å¤ªé˜³é•œï¼Œä¸”ä»·æ ¼ä½äº100ç¾å…ƒï¼Ÿ",
        "æˆ‘æƒ³è´­ä¹°2å‰¯Aviatorå¤ªé˜³é•œ",
        "é€€å›1å‰¯Classicå¤ªé˜³é•œ"
    ]

    for i, user_request in enumerate(test_cases, 1):
        print(f"\n{'='*60}")
        print(f"æµ‹è¯• {i}: {user_request}")
        print('='*60)

        # æ˜¾ç¤ºå½“å‰çŠ¶æ€
        print("\nğŸ“Š å½“å‰çŠ¶æ€:")
        print(f"  åº“å­˜å•†å“: {[item['name'] for item in inventory_tbl.all()]}")
        print(f"  å½“å‰ä½™é¢: ${get_current_balance():.2f}")

        # ç”Ÿæˆä»£ç è®¡åˆ’
        print("\nğŸ§  ç”Ÿæˆä»£ç è®¡åˆ’...")
        code_content = generate_code_plan(user_request)
        print(f"ç”Ÿæˆçš„ä»£ç å†…å®¹ (å‰200å­—ç¬¦):\n{code_content[:200]}...")

        # æ‰§è¡Œä»£ç 
        result = extract_and_execute_code(code_content, user_request)

        if result:
            print("\nğŸ“‹ æ‰§è¡Œç»“æœ:")
            print(f"  çŠ¶æ€: {result['status']}")
            print(f"  å›ç­”: {result['answer_text']}")

            if result['output']:
                print(f"  è¾“å‡º:\n{result['output']}")

            # æ˜¾ç¤ºæ›´æ–°åçš„çŠ¶æ€
            print("\nğŸ“Š æ›´æ–°åçŠ¶æ€:")
            print(f"  åº“å­˜å•†å“: {[item['name'] for item in inventory_tbl.all()]}")
            print(f"  å½“å‰ä½™é¢: ${get_current_balance():.2f}")

            # ä¿å­˜ä»£ç åˆ°æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
            code_filename = f"generated_code_{i}.py"
            with open(code_filename, 'w', encoding='utf-8') as f:
                f.write(f"# ç”Ÿæˆçš„ä»£ç  - æµ‹è¯•{i}: {user_request}\n")
                f.write(result['code'])
            print(f"  ğŸ’¾ ä»£ç å·²ä¿å­˜åˆ°: {code_filename}")
        else:
            print("âŒ æ‰§è¡Œå¤±è´¥")

    print("\n" + "="*60)
    print("ğŸ’¡ ä»£ç æ‰§è¡Œè§„åˆ’å®Œæˆ!")
    print("ç‰¹ç‚¹: ä»£ç å³è®¡åˆ’ï¼Œç›´æ¥æ‰§è¡Œï¼Œè¡¨è¾¾èƒ½åŠ›å¼º")
    print("å®‰å…¨è€ƒè™‘: éœ€è¦åœ¨å—æ§ç¯å¢ƒä¸­æ‰§è¡Œç”Ÿæˆçš„ä»£ç ")

if __name__ == "__main__":
    main()
```

### 3.3 è¿è¡Œç¤ºä¾‹
```bash
python code_execution_planner.py
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
ğŸ¤– ä»£ç æ‰§è¡Œè§„åˆ’ç³»ç»Ÿ
============================================================
ğŸ—„ï¸  è®¾ç½®æ•°æ®åº“...

============================================================
æµ‹è¯• 1: ä½ ä»¬æ˜¯å¦æœ‰åº“å­˜ä¸­çš„åœ†å½¢å¤ªé˜³é•œï¼Œä¸”ä»·æ ¼ä½äº100ç¾å…ƒï¼Ÿ
============================================================

ğŸ“Š å½“å‰çŠ¶æ€:
  åº“å­˜å•†å“: ['Aviator', 'Classic', 'Wayfarer']
  å½“å‰ä½™é¢: $500.00

ğŸ§  ç”Ÿæˆä»£ç è®¡åˆ’...
ç”Ÿæˆçš„ä»£ç å†…å®¹ (å‰200å­—ç¬¦):
<execute_python>
# æŸ¥æ‰¾åœ†å½¢å¤ªé˜³é•œ
Item = Query()
round_items = inventory_tbl.search(
    (Item.shape == 'åœ†å½¢') |
    (Item.description.test(lambda desc: 'åœ†å½¢' in (desc or '')))
)

# ç­›é€‰ä»·æ ¼ä½äº100ç¾å…ƒ
affordable_items = [item for item in round_items if item['price'] < 100]

# è®¾ç½®...

ğŸ“‹ æ‰§è¡Œç»“æœ:
  çŠ¶æ€: success
  å›ç­”: æ˜¯çš„ï¼Œæˆ‘ä»¬æœ‰ä¸€æ¬¾åœ†å½¢å¤ªé˜³é•œClassicï¼Œä»·æ ¼$60.00ï¼Œåº“å­˜10ä»¶ã€‚

ğŸ“Š æ›´æ–°åçŠ¶æ€:
  åº“å­˜å•†å“: ['Aviator', 'Classic', 'Wayfarer']
  å½“å‰ä½™é¢: $500.00
  ğŸ’¾ ä»£ç å·²ä¿å­˜åˆ°: generated_code_1.py
```

### 3.4 ä¼˜ç¼ºç‚¹åˆ†æ
**ä¼˜ç‚¹**ï¼š
- âœ… **é«˜è¡¨è¾¾èƒ½åŠ›**ï¼šä»£ç å¯ä»¥è¡¨è¾¾å¤æ‚çš„é€»è¾‘å’Œè®¡ç®—
- âœ… **ç›´æ¥æ‰§è¡Œ**ï¼šä»£ç å³è®¡åˆ’ï¼Œæ— éœ€é¢å¤–è§£æ
- âœ… **åˆ©ç”¨ç°æœ‰åº“**ï¼šå¯ä»¥ä½¿ç”¨Pandasã€NumPyç­‰æˆç†Ÿåº“
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šç ”ç©¶è¡¨æ˜ä»£ç æ‰§è¡Œä¼˜äºå…¶ä»–è§„åˆ’æ–¹å¼

**ç¼ºç‚¹**ï¼š
- âŒ **å®‰å…¨é£é™©**ï¼šéœ€è¦ä¸¥æ ¼æ§åˆ¶æ‰§è¡Œç¯å¢ƒ
- âŒ **å¯é æ€§é—®é¢˜**ï¼šç”Ÿæˆçš„ä»£ç å¯èƒ½æœ‰è¯­æ³•æˆ–é€»è¾‘é”™è¯¯
- âŒ **è°ƒè¯•å›°éš¾**ï¼šéœ€è¦å¤„ç†æ‰§è¡Œé”™è¯¯å’Œå¼‚å¸¸
- âŒ **æç¤ºè¯å¤æ‚**ï¼šéœ€è¦è¯¦ç»†çš„ä»£ç ç”ŸæˆæŒ‡å¯¼

### 3.5 å®‰å…¨è€ƒè™‘
1. **æ²™ç®±ç¯å¢ƒ**ï¼šåœ¨å—é™ç¯å¢ƒä¸­æ‰§è¡Œä»£ç 
2. **èµ„æºé™åˆ¶**ï¼šé™åˆ¶æ‰§è¡Œæ—¶é—´å’Œå†…å­˜ä½¿ç”¨
3. **è¾“å…¥éªŒè¯**ï¼šæ£€æŸ¥ä»£ç ä¸­çš„å±é™©æ“ä½œ
4. **æƒé™æ§åˆ¶**ï¼šé™åˆ¶æ–‡ä»¶ç³»ç»Ÿå’Œç½‘ç»œè®¿é—®

---

## 4. å®æˆ˜é¡¹ç›®ï¼šå®¢æœä»£ç†ç³»ç»Ÿ